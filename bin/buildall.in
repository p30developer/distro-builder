#!/bin/bash
# shellcheck disable=SC1091
TO_BUILD=(xfce gnome kde cinnamon i3 sway)

if [[ ! -v BUILDALL_TIMESTAMP ]]; then
    BUILDALL_TIMESTAMP="$(date +%y%m%d)"
fi

build_edition() {
    if ! test -f /var/cache/distro-tools/distro-builds/iso/"$1"/"$2"/"$BUILDALL_TIMESTAMP"/*.iso; then
        if ! buildiso -p "$2" -T "$BUILDALL_TIMESTAMP"; then
            echo "$2 ISO building failed. Manual intervention required!" | apprise -vv "${TELEGRAM}" -t "ISO build failed!"
            echo "$2" >> /var/cache/distro-tools/rebuild_needed.log
        fi
    fi

    rm -rf --one-file-system /var/cache/distro-tools/persianosx-chroots/buildiso/*
}

# Initialize building
rm -rf --one-file-system /var/cache/distro-tools/persianosx-chroots/buildiso/*
buildiso -i
source /var/cache/distro-tools/garuda-builds/.env

# Build our ISO's 
for edition in "${TO_BUILD[@]}"; do
    build_edition garuda "$edition"
done


#garuda-tools >>>> distro-tools
#garuda-builds >>>>  distro-builds
#garuda-chroots >>>> persianosx-chroots
